///// perform RFM segmentation analysis

// create RFM table 
create table dataRFM as
select id, transdate, sum(purchaseamount) as totalSPEND
from cleanDATAx
group by id, transdate;

// export new RFM table
create table csv_dump
row format delimited
fields terminated by ','
lines terminated by '\n' as
select * from capstone.dataRFM;



// import RFM data into R
setwd('\\\\files.loyalty.com/users/tmcdonald/My Documents/Big Data & Predictive Analytics')
dataRFM <- read.csv('dataRFM.csv', sep = ',', header = FALSE)

colnames(dataRFM) = c('customer_id', 'date_of_purchase', 'purchase_amount')
dataRFM$days_since = as.numeric(difftime(time1 = '2013-07-25', time2 = dataRFM$date_of_purchase, units = 'days'))
dataRFM[,'days_since']=round(dataRFM[,'days_since'],0)

install.packages("sqldf")
library("sqldf")

customers = sqldf('select customer_id, 
min(days_since) as 'recency',
count(*) as 'frequency', 
avg(purchase_amount) as 'amount'
from dataRFM 
group by 1')

head(customers)
summary(customers)
hist(customers$recency)
hist(customers$frequency)
hist(customers$amount)
hist(customers$amount, breaks = 100)
